<!DOCTYPE html>
<html>
  <head>
    <title>CSSS508, Week 9</title>
    <meta charset="utf-8">
    <meta name="author" content="Chuck Lanfear" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, top, title-slide

# CSSS508, Week 9
## Mapping
### Chuck Lanfear
### Nov 21, 2018<br>Updated: Nov 8, 2018

---







# Today

# Basic Mapping in `ggplot2`
* Mapping with raw `ggplot2` using coordinates
* Labeling points and using `ggrepel` to avoid overlaps
* `ggmap` for mashing up maps with `ggplot2`

# Advanced Mapping
* `sf`: [Simple Features](https://en.wikipedia.org/wiki/Simple_Features) geometry for R
* `tidycensus` for obtaining Census Bureau data


```r
library(ggplot2)
```

---
# Mapping in R: A quick plug

.pull-left[
.image-75[
![](img/bivand.jpg)
]
]

.pull-right[
If you are interested in mapping, GIS, and geospatial analysis in R, *acquire this book*.

[RSpatial.org](http://rspatial.org/) is a great resource as well.

You may also consider taking Jon Wakefield's **CSSS 554: Statistical Methods for Spatial Data**, however it is challenging and focuses more heavily on statistics than mapping.

[CSDE offers workshops](https://csde.washington.edu/training/workshops/) using [QGIS](https://qgis.org/en/site/) and/or ArcGIS. I recommend QGIS because it is free software with an extensive feature set and large user community.
]

---
class: inverse
# Basic Mapping in `ggplot2`

### Coordinates are just numbers!

---



---
# Terminology

* Simple Features (`sf`)
* Shapefile
* Coordinate Reference System (CRS)

---
# `sf`

Until recently, the main way to work with geospatial data in R was through the `sp` 
package. `sp` works well but does not store data the same way as most GIS packages
and can be bulky and complicated.

The more recent `sf` package implements the GIS standard of [**Simple Feature**](https://en.wikipedia.org/wiki/Simple_Features) in R.

`sf` is also integrated into the `tidyverse`: e.g. `geom_sf()` in `ggplot2`.

The package is somewhat new but is expected to *replace* `sp` eventually. The principle
authors and contributors to `sf` are the same authors as `sp` (including Bivand and Pebesma) but with new developers
from the `tidyverse` as well.

Because `sf` is the new standard, we will focus on it today.

---
# Simple Features

A [**Simple Feature**](https://en.wikipedia.org/wiki/Simple_Features) is a single observation with some defined geospatial location(s). Features are stored in special data frames (class `sf`) with two properties:

--

* **Geometry**: Properties describing a location (usually on Earth).
   * Usually 2 dimensions, but support for up to 4. 
   * Stored in a single reserved *list-column* (`geom`, of class `sfc`).&lt;sup&gt;1&lt;/sup&gt;
   * Contain a defined coordinate reference system.

.footnote[
[1] A list-column is the same length as all other columns in the data, but each element contains *sub-elements* (class `sfg`) with all the geometrical components. 

*List-columns* require special functions to manipulate *including removing them*.
]

--

* **Attributes**: Characteristics of the location (such as population).
   * These are non-spatial measures that describe a feature.
   * Standard data frame columns.



---
## Coordinate Reference Systems

**Coordinate reference systems** (**CRS**) specify what location on Earth geometry coordinates are *relative to* (i.e. what location is (0,0) when plotting).

The most commonly used is [**WGS84**](https://en.wikipedia.org/wiki/World_Geodetic_System), the standard for Google Earth, the Department of Defense, and GPS satellites.

There are two common ways to define a CRS:

* [**EPSG codes**](http://spatialreference.org/ref/epsg/) (`epsg` in R)
   * Numeric codes which *refer to a predefined projection*
   * Ex: WGS84 is `4326`

* [**PROJ.4 strings**](https://proj4.org/usage/quickstart.html) (`proj4string` in R)
   * Text strings which *define a projection*
   * WGS84 looks like this:

```
+init=epsg:4326 +proj=longlat +ellps=WGS84
+datum=WGS84 +no_defs +towgs84=0,0,0
```

---
# Shapefiles

Geospatial data is typically stored in **shapefiles** which store geometric data as **vectors** with associated attributes (variables)

Shapefiles actually consist of multiple individual files. There are always at least three (but up to 10+):

`.shp`: The feature geometries
`.shx`: Shape positional index
`.dbf`: Attributes describing features&lt;sup&gt;1&lt;/sup&gt;

Often there will also be a `.prj` file defining the coordinate system.

.footnote[[1] This is just a dBase IV file which is an ancient and common database storage file format.]

---
# `sf`


```r
library(sf)
```

```
## Linking to GEOS 3.6.1, GDAL 2.2.3, proj.4 4.9.3
```

---


```r
# Use sf to create the seattle_tracts df
```

---

```r
load("seattle_tracts.RData")

ggplot(seattle_tracts, aes(fill=Experiment)) + 
  geom_sf(size=0.1, color="white") + # Thin white outline
  coord_sf(datum=NA) +               # Remove graticule lines
  scale_fill_manual(values = c(      # Manual hex colors
    "Mailbox, Litter Intervention" = "#342c5c",
    "Mailbox"                      = "#458490",
    "Litter Intervention"          = "#905145",
    "No Letters"                   = "grey",
    "Only Letters"                 = "#cbd3a3")) +
  theme_minimal(base_size = 20)      # Large text
```

---

![](CSSS508_week9_mapping_files/figure-html/unnamed-chunk-5-1.svg)&lt;!-- --&gt;

---
class: inverse
# `tidycensus`

---
`tidycensus`

`tidycensus` can be used to search the American Community Survey (ACS) and Dicennial
Census for variables, then download them and automatically format them as tidy dataframes.

**These dataframes include geographical boundaries such as tracts!**

This package utilizes the Census API, so you will need to obtain a [Census API key](https://api.census.gov/data/key_signup.html).
I talk more about APIs in the Social Media Data and Text Mining lecture.

## The Basics:

**Application Program Interface (API)**: A type of computer interface that exists as the 
"native" method of communication between computers, often via http (usable via `httr` package).
* R packages that interface with websites and databases typically use APIs.
* APIs make accessing data easy while allowing websites to control access.


```r
library(tidycensus)
# census_api_key("PUT YOUR KEY HERE", install=TRUE)
```

---
# Key `tidycensus` Functions

* `census_api_key()` - Install a census api key
* `load_variables()` - Load searchable variable lists
* `get_decennial()` - Load Census variables and geographical boundaries.
* `get_acs()` - Load ACS variables and boundaries

---
# Searching for Variables


```r
acs_2015_vars &lt;- load_variables(2015, "acs5")
acs_2015_vars[10:18,] %&gt;% print() 
```

```
## # A tibble: 9 x 3
##   name       label                                 concept   
##   &lt;chr&gt;      &lt;chr&gt;                                 &lt;chr&gt;     
## 1 B01001_008 Estimate!!Total!!Male!!20 years       SEX BY AGE
## 2 B01001_009 Estimate!!Total!!Male!!21 years       SEX BY AGE
## 3 B01001_010 Estimate!!Total!!Male!!22 to 24 years SEX BY AGE
## 4 B01001_011 Estimate!!Total!!Male!!25 to 29 years SEX BY AGE
## 5 B01001_012 Estimate!!Total!!Male!!30 to 34 years SEX BY AGE
## 6 B01001_013 Estimate!!Total!!Male!!35 to 39 years SEX BY AGE
## 7 B01001_014 Estimate!!Total!!Male!!40 to 44 years SEX BY AGE
## 8 B01001_015 Estimate!!Total!!Male!!45 to 49 years SEX BY AGE
## 9 B01001_016 Estimate!!Total!!Male!!50 to 54 years SEX BY AGE
```

---
# Processing Data




```r
king_county &lt;- get_acs(geography="tract", state="WA", county="King",
                       geometry = TRUE,
                       variables=c("B02001_001E", "B02009_001E")) %&gt;% 
  select(-moe) %&gt;% group_by(GEOID) %&gt;% spread(variable, estimate) %&gt;% 
  rename(`Total Population`=B02001_001, `Any Black`=B02009_001) %&gt;%
  mutate(`Any Black` = `Any Black` / `Total Population`)
head(king_county)
```

---
# Mapping Code


```r
king_county %&gt;% ggplot(aes(fill=`Any Black`)) + geom_sf() + 
  coord_sf(crs = "+proj=longlat +datum=WGS84", datum=NA) + 
  scale_fill_continuous(name="Any Black\n", 
                        low="#d4d5f9", high="#00025b") + 
  theme_minimal() + ggtitle("Proportion Any Black")
```

New functions:

* `geom_sf()` draws Simple Feature coordinate data.
* `coord_sf()` is used here with these arguments:
   * `crs`: Modifies the coordinate reference system (CRS), often called a "projection"; WGS84 is possibly the most commonly used CRS.
   * `datum=NA`: Removes graticule lines, which are geographical lines such as meridians and parallels.

---
# Map
![](CSSS508_week9_mapping_files/figure-html/king_plot-1.svg)&lt;!-- --&gt;

---
class: inverse
# Homework Exercise


Use the HW 7 template to practice making maps of the restaurant inspection data. 

If you wish to submit it for bonus points, turn it in via Canvas by midnight on Tuesday the 29th.

There will be no peer review.
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "tomorrow-night-bright",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
